services:
  colibri:
    container_name: colibri-web
    profiles:
      - preview
    build:
      context: .
      args:
        PORT: 3000
    environment:
      DB_URL: "postgres://colibri:colibri@postgres:5432/colibri"
      DATABASE_CERTIFICATE: ""
      STORAGE_S3_URL: "http://minio:9000"
    networks:
      colibri:
    ports:
      - published: 3000
        target: 3000
        protocol: tcp
        app_protocol: http
        name: colibri
        mode: ingress
        host_ip: "127.0.0.1"

  postgres:
    image: ghcr.io/colibri-hq/postgres:18
    environment:
      POSTGRES_USER: colibri
      POSTGRES_PASSWORD: colibri
      POSTGRES_DB: colibri
    secrets:
      - source: pgsodium_key
        target: /run/secrets/pgsodium_key
    configs:
      - source: postgres-init-roles
        target: /bootstrap/0_roles.sql
        mode: 0777
      - source: postgres-init-schema
        target: /docker-entrypoint-initdb.d/0_init.sh
        mode: 0777
    volumes:
      - source: postgres
        target: /var/lib/postgresql
        consistency: delegated
        type: volume
      - source: ./supabase
        target: /colibri
        consistency: cached
        read_only: true
        type: bind
    networks:
      colibri:
    expose:
      - 5432
    ports:
      - published: 5432
        target: 5432
        protocol: tcp
        app_protocol: postgresql
        name: postgres
        mode: ingress
        host_ip: "127.0.0.1"

  minio:
    image: minio/minio:latest
    environment:
      MINIO_ROOT_USER: colibri
      MINIO_ROOT_PASSWORD: password
    # language=bash
    command: >
      server --console-address ":9001" /data
    volumes:
      - source: minio
        target: /data
        consistency: delegated
        type: volume
    healthcheck:
      # language=bash
      test: [ "CMD", "curl", "-fs", "localhost:9000/minio/health/live" ]
      interval: 5s
      timeout: 20s
      retries: 10
    networks:
      colibri:
    expose:
      - 9000
      - 9001
    ports:
      - published: 9000
        target: 9000
        protocol: tcp
        app_protocol: http
        name: minio
        mode: ingress
        host_ip: "127.0.0.1"
      - published: 9001
        target: 9001
        protocol: tcp
        app_protocol: http
        name: minio-console
        mode: ingress
        host_ip: "127.0.0.1"
  minio_setup:
    image: minio/mc:latest
    depends_on:
      minio:
        condition: service_healthy
    # language=bash
    entrypoint: >
      /bin/sh -c "
      /usr/bin/mc alias set colibri-minio http://minio:9000 colibri password;
      /usr/bin/mc mb colibri-minio/colibri-bucket;
      exit 0;
      "
    networks:
      colibri:

networks:
  colibri:
    name: colibri

volumes:
  postgres:
    name: colibri_postgres
  minio:
    name: colibri_minio

configs:
  # region Postgres
  postgres-init-roles:
    # language=postgresql
    content: |
      create role anon;
      create role authenticated;
      create role service_role bypassrls;
      create role postgres bypassrls;
  postgres-init-schema:
    # language=bash
    content: |
      #!/usr/bin/env bash
      set -euo pipefail

      function apply_schema() {
        local file="$${1}"
        echo "Applying schema changes from '$${file}'â€¦"
        psql \
          --set ON_ERROR_STOP=ON \
          --single-transaction \
          --dbname colibri \
          --user=colibri \
          --echo-errors \
          --quiet \
          --file "$${file}"
      }
      
      function apply_files() {
        local files=("$${@}")
        for file in "$${files[@]}"; do
          if [ -f "$${file}" ]; then
            apply_schema "$${file}"
          else
            echo "Warning: File '$${file}' not found. Skipping."
          fi
        done
      }

      schema_files=(
        /bootstrap/*.sql
        /colibri/schema/*.sql
      )

      if [ "$${#schema_files[@]}" -eq 0 ]; then
        echo "No schema files found in /bootstrap or /colibri/schema. Aborting."
        exit 1
      fi

      apply_files "$${schema_files[@]}"

      if [ -n "$$(find /colibri/migrations -maxdepth 0 -not -empty)" ]; then
        migration_files=(
          /colibri/migrations/*.sql
        )

        apply_files "$${migration_files[@]}"
      else
        echo "No pending migrations found."
      fi
      
      if [ -n "$$(find /colibri/seeds -maxdepth 0 -not -empty)" ]; then
        seed_files=(
          /colibri/seeds/*.sql
        )
      
        apply_files "$${seed_files[@]}"
      else
        echo "No pending seeds found."
      fi
  # endregion

secrets:
  pgsodium_key:
    environment: COLIBRI_ENCRYPTION_KEY
